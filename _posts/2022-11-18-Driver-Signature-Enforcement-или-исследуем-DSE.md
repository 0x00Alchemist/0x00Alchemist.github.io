---
layout: post
title: Drowning In The Kernel - Driver Signature Enforcement! 
description: Исследуем инициализацию механизма проверки подписи драйверов в Windows
summary: Понять, как инициализируется DSE
tags: Windows DSE
minute: 10
---
![](https://telegra.ph/file/4e9862e1da916ff8cbcbe.png)

Хм.
Допустим, мы должны убедиться, что у какого-либо драйвера есть собственная цифровая подпись. Так и еще чтоб она была валидной! Логично, что для этого нужен какой-либо механизм, совершающий подобные проверки. Ну, что же, да, таков есть в Windows и ни для кого это не секрет. 

Садитесь удобнее, сегодня мы попытаемся понять, где обитает DSE и почему он причиняет боль многим любителям говна в режиме ядра.


## Что такое DSE? 

DSE - аббревиатура от словосочетания Driver Signature Enforcement. На самом деле это весьма комплексный механизм Code Integrity, он существует для "защиты" от неподписанных компонентов ядра, следовательно предполагает, что каждый драйвер устройства (или иной другой системный файл, выгружаемый в адресное пространство ядра) должен иметь собственную цифровую подпись. В противном случае, система просто откажется грузить этот компонент.
Стоит на всякий случай сказать, что изменение системных файлов убивает подпись, поэтому, мои маленькие любители подрочить в ядре, это не прокатит и система скажет, что такой файл не загрузит! Так что да, эта технология существует по большому счету для защиты от вредоносов, работающих на уровне ядра. И, в принципе, он справляется вполне себе неплохо!

DSE включен по стандарту, но пользователям (только из под админа, конечно же) предоставляется возможность выключить на время проверку подписей (или включить Test Signing Mode, позволяющий загружать самоподписанные драйвера), например, через bcdedit. Правда, это чаще всего нужно только для разработчиков драйверов, когда они тестируют свои наработки.

С понятием DSE мы вроде разобрались, перейдем к теперь к его инициализации.


## Инициализация Driver Signature Enforcement и Code Integrity

DSE является компонентом ядра, а значит, надо искать примерно на этом уровне или чуточку ниже.

DSE берет свое начало с фазы "ранней загрузки" системы - когда свое дело закончили загрузчики (в данном случае - winload.exe/winload.efi). Это дело выгружается с основными драйверами системы. Нужный нам покемон находится в CI.dll (CodeIntegrity). Если обратить внимание на то, что экспортирует данная DLL мы однозначно можем сказать, что нам нужна функция под именем `CiInitialize`:
![](https://telegra.ph/file/7fb3cd9c955cf7729785a.png)

Однако, давайте не спешить, мы зайдем немного с другого угла и чуточку уйдем от CI.dll.

Все же не менее важным для ОС, как ни странно, является ядро, а это значит, что упоминание CiInitialize должно быть и там.
В действительности, так и есть, более того, эта функция также вызывается во время инициализации системы. *Барабанная дробь*...

Давайте посмотрим на функцию из ntoskrnl.exe - `SepInitializeCodeIntegrity`.
![](https://telegra.ph/file/6903d2a8ee5d3114b8c9e.png)

А теперь приведем её в более приличный (и правильный) вид. Заодно я оставлю её как "код", надеюсь, так будет удобнее:

```
NTSTATUS SepInitializeCodeIntegrity() {
   unsigned int CiOptions;
   _LIST_ENTRY *p_BootDriverListHead;
   _LOADER_PARAMETER_EXTENSION *Ext;
   _LOADER_PARAMETER_CI_EXTENSION *CodeIntegrityData;
   char *LoadOptions;

   CiOptions = 6;
   memset(&CodeIntegrityCallbacks, 0, 0xC4); // nt!SeCiCallbacks

   p_BootDriverListHead = 0;
   SeCiCallbacks = 0xD0;
   qword_140C1DAA8 = 0xA000008; // nt!SeCiCallbacks + 0xC8

   if(KeLoaderBlock ) {
      Ext = KeLoaderBlock->Extension;
       if(Ext) {
           CodeIntegrityData = Ext->CodeIntegrityData;
           if(CodeIntegrityData)
               CiOptions = CodeIntegrityData->CodeIntegrityOptions;
       }

       // (KeLoaderBlock + 0xD8)
       LoadOptions = KeLoaderBlock->LoadOptions;
       if(SepIsOptionPresent(LoadOptions) && LoadOptions)
           SeCiDebugOptions |= 1;
       if(KeLoaderBlock)
           p_BootDriverListHead = &KeLoaderBlock->BootDriverListHead;
   }

   return CiInitialize(CiOptions, p_BootDriverListHead, &SeCiCallbacks, SeCiPrivateApis);
}
```

Именно в этой функции мы получаем информацию о существовании `CiInitialize` впервые, правда, уже через само ядро. Думаю, стоит разобрать поближе несколько моментов.

И начну я пожалуй с `SeCiPrivateApis`, так как они требуют меньше объяснений и о них можно сказать прямо сейчас. Из названия логично предположить, что `SeCiPrivateApis` содержит в себе список некоторых функций, с которыми работает модуль Code Integrity. Данный список содержит в себе оффсеты на функции: `PsQueryProcessSignatureMitigationPolicy`, `VslHvciInterface` (это оффсет на `VslCreateSecureAllocation`), `SepZwLockRegistryKey`, `PsQuerySectionSignatureInformation`, `SepSetRuntimeUpdatableSigningLevel`, `RtlValidProcessProtection`, `MmGetImageFileSignatureInformation` и `SepGetSystemSigningLevel`.
Данные функции не будут разбираться в этой статье, однако, я покажу несколько из них.
![](https://telegra.ph/file/3c57bbca915d7293f7d72.png)
![](https://telegra.ph/file/b45274c032ea9926fd1b6.png)

Назначение `SeCiCallbacks` я разберу в следующем параграфе. Также, не выкидывайте из головы структуру `_LOADER_PARAMETER_CI_EXTENSIONS`, с ней есть одна забавная особенность.

Кстати, забыл показать call stack. Да, функция и в правду вызывается во время инициализации:
![](https://telegra.ph/file/e4abbe662744d8cde2132.png)

## От ядра к модулю

Хорошо, мы поняли, что за инициализацию DSE в ядре отвечает функция `SepInitializeCodeIntegrity`, данная функция срабатывает во время инициализации самой системы и она вызывает нужный нам `CiInitialize`. 
Самое время глянуть на `CiInitialize`! Ииииииии...
![](https://telegra.ph/file/9c1b4d27a34a71d1aee9b.png)

Да, это очередной враппер над еще одной функцией - `CipInitialize`. Интересно, что тут мы имеем упоминание Microsoft WIL (Windows Implementation Library). Это нас не должно особо волновать, данные вещи нам не нужны и не мешают, но, решил просто это отметить.


Хорошо, `CiInitialize` - это враппер. Значит, идем прямиком в `CipInitialize`! И, да, это она, именно она отвечает за инициализацию нашего DSE. Это весьма большая функция, поэтому придется разместить её на нескольких скринах. Надеюсь, вы не против.
![](https://telegra.ph/file/a2e2be4196b714a7a4dc8.png)
![](https://telegra.ph/file/fa5d863955762c1677c12.png)
![](https://telegra.ph/file/39ee3395136919466487d.png)

Отлично, мы нашли, где инициализируется DSE! Давайте разберем наиболее примечательные детали.
![](https://telegra.ph/file/f8d2a79350cd44cb79e01.png)

Данный отрывок проверяет, существует ли оффсет на `VslHvciInterface`. Если да - заполняет таблицу `g_CiVslHvciInterface`. Я так и не смог понять, точно ли это то, что должно быть в данной таблице (да-да, называйте меня дауном-долбоебом-уебком-etc), поэтому, не упомяну ничего здесь во избежание ошибок. Но, предполагаю, что загружает оно какую-то часть функций отсюда:
![](https://telegra.ph/file/0fe78ac2a60ef3ccfb6f2.png)

Скорее всего оно загружает все, начиная с `VslCreateSecureAllocation` (присутствует в `CiPrivateApis`) + `0x10`.

Здесь при вызове HashpSelfTest CI.dll тестирует собственную подпись, что очевидно. В условии тестируются собственные "Root Table".
![](https://telegra.ph/file/1aa55a84e5f35e98ded44.png)
![](https://telegra.ph/file/20d7bb247df59109a70da.png)

А вот здесь у нас есть немножечко примеси Xbox (`XciInitialize` импортируется из `ext-ms-win-ci-xbox-l1-1-0`), живите с этим.
![](https://telegra.ph/file/d193ed2b36bc07faed7c1.png)

А вот и самое главное - таблица коллбеков! Именно функции этой таблицы и отвечают за проверку подписей, а значит, мы технически нашли, то, что нам нужно!
![](https://telegra.ph/file/820e3130699acad4b27c4.png)

Самое главное, что делает `CipInitialize` - заполняет таблицу `CiCallbacks`, а `CiInitialize` передает заполненную таблицу ядру. Теперь, мы поняли, как иницализируется механизм проверки подписей. Осталось понять, каким образом проверяются загружаемые системные модули.


## Мы любим только проверенные образы

Когда необходимая таблица с указателями на функции заполнилась - система может начинать совершать проверку загружаемых образов в пространство ядра.

Опытным путем было найдено несколько функций, отвечающих за это. Например, `SeValidateImageHeader`:
![](https://telegra.ph/file/9799da23dd5d410bd4d46.png)

Здесь проводится проверка, существует ли `SeCiCallbacks` (или `CiCallbacks`, как я обозначал ранее) со смещением `0x20` (`CiValidateImageHeader`), если да - производим проверку, в противном случае возвращаем NTSTATUS равный `0xC0000428` (`STATUS_INVALID_IMAGE_HASH`). Call stack для `SeValidateImageHeader` выглядит так:
![](https://telegra.ph/file/15d4b12d4eebb007309b3.png)

Т.е, путь до проверки заголовка образа проходит от загрузки (`MmLoadSystemImage`) до самой валидации (`SeValidateImageHeader` и `CiValidateImageHeader`).

Это справедливо и для других функций, например для `SeValidateImageData` и `CiValidateImageData`!


## WinDBG и DSE

Забавно, но стоит отметить, что WinDBG, если мы занимаемся отладкой ядра/бутменеджера/бутлоадера, сам отключает DSE, судя по всему это связано со структурой `_LOADER_PARAMETER_CI_EXTENSIONS`:
![](https://telegra.ph/file/16d6ffa7b4779e041b155.png)


## Структура _LOADER_PARAMETER_CI_EXTENSIONS

К сожалению, у меня она почему-то решила не загружаться (110% я криворукий долбоеб), поэтому вам придется поверить мне на слово, но обычно параметр CodeIntegrityOptions равен 6, однако, при подключенном WinDBG это поле скорее всего становится 0. Скорее всего это связано с тем, что настройки при отладке ядра изменяют это поле, а заодно вместе с ними и WinDBG. Если мы вспомним с чего мы начинали, то можем увидеть это же значение:

```
CiOptions = 6;
```

И, да, скорее всего это один из способов обхода механизма DSE.


## Выводы

В данной статье я немного разобрал механизм инициализации Driver Signature Enforcement, а также немного рассказал, как он работает. Конечно, здесь непаханное поле экспериментов и можно еще что-то глянуть даже. 

Как-то так, не скучайте, не болейте, кушайте хорошо. Водички побольше пейте, воооооот.
