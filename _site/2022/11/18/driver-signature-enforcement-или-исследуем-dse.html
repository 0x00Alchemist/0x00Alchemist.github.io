<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="Discover a clean and straightforward Jekyll blogging theme with our simple and minimal template. Github Pages ready, user-friendly design, easy to set up and low maintenance, letting you focus on creating content."><link rel="stylesheet" href="http://localhost:4000/assets/css/syntax.css"><link rel="preconnect" href="https://cdnjs.cloudflare.com"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><title> Drowning In The Kernel - Driver Signature Enforcement! - alchemist.</title><link rel="shortcut icon" href="http://localhost:4000/favicon.png"><link rel="alternate" type="application/atom+xml" title="alchemist." href="http://localhost:4000/atom.xml"><link rel="alternate" type="application/json" title="alchemist." href="http://localhost:4000/feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="http://localhost:4000/sitemap.xml" /><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&family=Source+Code+Pro:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,300;1,400;1,500;1,600;1,700;1,900&display=swap" rel="stylesheet"><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}html{font-size:15px}#theme-toggle{opacity:.65;position:relative;border-radius:5px;height:25px;display:flex;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center;transition:opacity .3s ease 0s;border:none;outline:none;background:none;cursor:pointer;padding:0px;appearance:none;transform:scale(0.8)}html,html[data-theme=light]{--text-font: Play;--source-code-font: Source Code Pro;--very-light-text-color: rgb(222, 222, 222);--light-text-color: rgb(89, 183, 255);--medium-text-color: #555;--main-text-color: #333;--highlight-text-color: #6cb4a0;--dark-text-color: #393e46;--link-color: rgb(50, 87, 209);--code-bg-color: rgb(245, 245, 245);background-color:#fff}html #theme-toggle div,html[data-theme=light] #theme-toggle div{position:relative;width:24px;height:24px;border-radius:50%;border:none;background-color:var(--theme-ui-colors-transparent, transparent);transform:scale(1);transition:all .45s ease 0s;overflow:hidden;box-shadow:inset 8px -8px 0px 0px var(--theme-ui-colors-toggleIcon, #2d3748)}html #theme-toggle div::before,html[data-theme=light] #theme-toggle div::before{content:"";position:absolute;right:-9px;top:-9px;height:24px;width:24px;border:none;border-radius:50%;transform:translate(0px, 0px);opacity:1;transition:transform .45s ease 0s}html #theme-toggle div::after,html[data-theme=light] #theme-toggle div::after{content:"";width:8px;height:8px;border-radius:50%;margin:-4px 0px 0px -4px;position:absolute;top:50%;left:50%;box-shadow:0 -23px 0 var(--theme-ui-colors-toggleIcon, #2d3748),0 23px 0 var(--theme-ui-colors-toggleIcon, #2d3748),23px 0 0 var(--theme-ui-colors-toggleIcon, #2d3748),-23px 0 0 var(--theme-ui-colors-toggleIcon, #2d3748),15px 15px 0 var(--theme-ui-colors-toggleIcon, #2d3748),-15px 15px 0 var(--theme-ui-colors-toggleIcon, #2d3748),15px -15px 0 var(--theme-ui-colors-toggleIcon, #2d3748),-15px -15px 0 var(--theme-ui-colors-toggleIcon, #2d3748);transform:scale(0);transition:all .35s ease 0s}html[data-theme=dark]{--text-font: Play;--source-code-font: Source Code Pro;--very-light-text-color: #EEE;--light-text-color: #c4bbf0;--medium-text-color: #52057b;--main-text-color: #EAEAEA;--highlight-text-color: #6cb4a0;--dark-text-color: rgb(36, 38, 42);--link-color: rgb(255, 89, 125);--code-bg-color: rgb(36, 38, 42);background-color:#131418}html[data-theme=dark] #theme-toggle div{position:relative;width:24px;height:24px;border-radius:50%;border:4px solid var(--theme-ui-colors-toggleIcon, #cbd5e0);background-color:var(--theme-ui-colors-toggleIcon, #cbd5e0);transform:scale(0.55);transition:all .45s ease 0s;overflow:visible;box-shadow:none}html[data-theme=dark] #theme-toggle div::before{content:"";position:absolute;right:-9px;top:-9px;height:24px;width:24px;border:2px solid var(--theme-ui-colors-toggleIcon, #cbd5e0);border-radius:50%;transform:translate(14px, -14px);opacity:0;transition:transform .45s ease 0s}html[data-theme=dark] #theme-toggle div::after{content:"";width:8px;height:8px;border-radius:50%;margin:-4px 0px 0px -4px;position:absolute;top:50%;left:50%;box-shadow:0 -23px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),0 23px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),23px 0 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),-23px 0 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),15px 15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),-15px 15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),15px -15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),-15px -15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0);transform:scale(1);transition:all .35s ease 0s}body{font-family:var(--text-font),monospace;text-rendering:optimizeLegibility;line-height:1.75;color:var(--main-text-color)}a{color:var(--link-color);text-decoration:none}.post p{margin:1rem 0}.meta{margin:1.4rem 0}code,pre{background:var(--code-bg-color);margin:0 -27px;border-width:1px}code{font-family:var(--source-code-font),monospace;margin:unset;padding:.1rem;color:var(--highlight-text-color)}pre code{background-color:unset;color:unset}pre{border-width:3px;padding:.8rem;white-space:pre-wrap;border-style:none none none solid;border-color:var(--light-text-color)}img{max-width:100%}hr{background:var(--light-text-color);height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem 0}section{margin-top:5.5rem}blockquote{font-style:italic;border-left:5px solid var(--dark-text-color);padding-left:1rem}h1{color:var(--main-text-color);text-transform:uppercase;font-size:2rem;font-weight:bold;margin-bottom:1.5rem}h2,h3,h4,h5{font-weight:bold;margin-bottom:1.5rem;font-size:2rem}h2{font-size:1.8rem}h3{font-size:1.6rem}h4{font-size:1.4rem}h5{font-size:1.2rem}h6{font-size:1rem}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:.5rem}.posts>h3{font-weight:500}.post ul{margin:0px;margin:0px 0px 10px 10px}.post ol{margin:0px;margin:0px 0px 10px 15px}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:bold}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}time{color:var(--main-text-color)}.post>h1.title{font-size:x-large;margin-top:0;margin-bottom:0}.post>time{margin-bottom:0;margin-top:3rem}.highlight{margin:0px}main{display:flex;max-width:47rem;margin:-5rem auto 0;padding:2.4rem 2rem;flex-direction:column}.flex-row-between{display:flex;flex-direction:row;justify-content:space-between}.social-footer{padding:1rem;display:flex;justify-content:center;position:initial}.social-footer .social-footer-icons .fa{font-size:1.3rem;color:#a9a9a9}.social-footer .social-footer-icons .fa:hover{color:dimgray;transition:color .3s ease-in}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:.5rem}main{padding:0 2rem}}section{flex-grow:999;display:flex;flex-direction:column}figcaption{font-size:smaller}.bio{margin-bottom:5rem}::selection{background-color:#fffba0;color:#333}.search-article{position:relative}.search-article label[for=search-input]{position:relative;top:-10px;left:11px}.search-article input[type=search]{top:-1rem;left:0;border:0;width:100%;height:30px;outline:none;position:absolute;border-radius:5px;padding:10px 10px 10px 35px;color:var(--main-text-color);-webkit-appearance:none;background-color:rgba(128,128,128,.1);border:1px solid rgba(128,128,128,.1)}.search-article input[type=search]::-webkit-input-placeholder{color:gray}.search-article input[type=search]::-webkit-search-decoration,.search-article input[type=search]::-webkit-search-results-decoration{display:none}#search-results{list-style:none;text-align:center}#search-results li{text-align:center}#search-results li::before{content:"›";display:inline-block;margin-left:-1.3em;width:1.3em;color:var(--main-text-color)}.post-nav{display:flex;position:relative;margin-top:0;border-top:2px solid var(--light-text-color);line-height:1.4}.post-nav .post-nav-item{border-bottom:0;padding-bottom:10px;width:50%;padding-top:10px;text-decoration:none;box-sizing:border-box}.post-nav .post-nav-item .post-title{color:var(--main-text-color)}.post-nav .post-nav-item:hover .post-title,.post-nav .post-nav-item:focus .post-title{color:var(--link-color);opacity:.9}.post-nav .post-nav-item .nav-arrow{font-size:17px;color:var(--main-text-color);margin-bottom:3px;font-weight:bold}.post-nav .post-nav-item:nth-child(odd){padding-left:0;padding-right:20px}.post-nav .post-nav-item:nth-child(even){text-align:right;padding-right:0;padding-left:20px}.tags ul{list-style:none;display:grid;grid-template-columns:auto auto auto auto auto auto;grid-template-rows:auto auto auto auto}.tags li{white-space:normal;text-overflow:ellipsis}.timeline{position:center;width:650px;margin:-6em auto;padding:1px;list-style-type:none}@media(max-width: 860px){.timeline{width:100%}}.timeline:before{position:absolute;left:50%;top:0;content:" ";display:block;width:6px;height:100%;margin-left:-3px;background:var(--light-text-color);z-index:5}@media(max-width: 375px){.timeline:before{height:150%}}.timeline li{padding:2em 0}@media(max-width: 860px){.timeline li{padding:2em 0}}.timeline li::after{content:"";display:block;height:150%;clear:both;visibility:hidden}.direction-l{position:relative;width:287px;float:left;text-align:right}@media(max-width: 860px){.direction-l{float:none;width:100%;text-align:center}}.direction-l .flag{color:#333;box-shadow:-1px 1px 1px rgba(0,0,0,.52)}.direction-l .flag:after{content:"";position:absolute;left:100%;top:50%;height:0;width:0;margin-top:-8px;border:solid rgba(0,0,0,0);border-left-color:#f8f8f8;border-width:8px;pointer-events:none}@media(max-width: 860px){.direction-l .flag:after{content:"";position:absolute;left:50%;top:-8px;height:0;width:0;margin-left:-8px;border:solid rgba(0,0,0,0);border-bottom-color:#fff;border-width:8px;pointer-events:none}}.direction-l .time-wrapper{float:left}@media(max-width: 860px){.direction-l .time-wrapper{float:none}}.direction-r{position:relative;width:293px;float:right;text-align:left}@media(max-width: 860px){.direction-r{float:none;width:100%;text-align:center}}.direction-r .flag{color:#333;box-shadow:1px 1px 1px rgba(0,0,0,.52)}.direction-r .flag:after{content:"";position:absolute;right:100%;top:50%;height:0;width:0;margin-top:-8px;border:solid rgba(0,0,0,0);border-right-color:#f8f8f8;border-width:8px;pointer-events:none}@media(max-width: 860px){.direction-r .flag:after{content:"";position:absolute;left:50%;top:-8px;height:0;width:0;margin-left:-8px;border:solid rgba(0,0,0,0);border-bottom-color:#fff;border-width:8px;pointer-events:none}}.direction-r .flag:before{left:-40px}.direction-r .time-wrapper{float:right}@media(max-width: 860px){.direction-r .time-wrapper{float:none}}.flag-wrapper{position:relative;display:inline-block;text-align:center}@media(max-width: 860px){.flag-wrapper{text-align:center}}.flag-wrapper .flag{position:relative;display:inline;background:#f8f8f8;padding:6px 10px;border-radius:5px;font-weight:600;text-align:left}@media(max-width: 860px){.flag-wrapper .flag{background:#fff;z-index:15}}.direction-l .flag:before,.direction-r .flag:before{position:absolute;top:60%;right:-40px;content:" ";display:block;width:12px;height:12px;margin-top:-10px;background:#fff;border-radius:10px;border:4px solid var(--link-color);z-index:10}@media(max-width: 860px){.direction-l .flag:before,.direction-r .flag:before{position:absolute;top:-30px;left:53%;content:" ";display:block;margin-left:-10px}}.time-wrapper{display:inline;line-height:1em;font-size:.66666em;color:var(--link-color);vertical-align:middle}@media(max-width: 860px){.time-wrapper{display:block;position:relative;margin:4px 0 0 0;z-index:14}}.time-wrapper .time{display:inline-block;padding:4px 6px;background:#f8f8f8}.desc{margin:1em .2em -3.5em 0;font-size:.9em;line-height:1.5em}.desc a{color:var(--link-color);text-decoration:none}.desc a:hover{text-decoration:underline}@media(max-width: 860px){.desc{position:relative;margin:1em 1em 0 1em;padding:1em;background:var(--code-bg-color);box-shadow:0 0 1px rgba(0,0,0,.2);z-index:15}}</style></head><body><main><section class="post"><div class="flex-row-between"> <a href="http://localhost:4000/">« back</a> <button title="Change theme" id="theme-toggle" onclick="modeSwitcher()"><div></div></button></div><time datetime="2022-11-18T00:00:00+02:00">Nov 18, 2022 - 10 ' read</time><h1 class="title"> Drowning In The Kernel - Driver Signature Enforcement!</h1><span class="meta"> <a href="http://localhost:4000/tag/Windows">Windows</a>, <a href="http://localhost:4000/tag/DSE">DSE</a></span><p><img src="https://telegra.ph/file/4e9862e1da916ff8cbcbe.png" alt="" /></p><p>Хм. Допустим, мы должны убедиться, что у какого-либо драйвера есть собственная цифровая подпись. Так и еще чтоб она была валидной! Логично, что для этого нужен какой-либо механизм, совершающий подобные проверки. Ну, что же, да, таков есть в Windows и ни для кого это не секрет.</p><p>Садитесь удобнее, сегодня мы попытаемся понять, где обитает DSE и почему он причиняет боль многим любителям говна в режиме ядра.</p><h2 id="что-такое-dse"> Что такое DSE? <a href="#что-такое-dse">#</a></h2><p>DSE - аббревиатура от словосочетания Driver Signature Enforcement. На самом деле это весьма комплексный механизм Code Integrity, он существует для “защиты” от неподписанных компонентов ядра, следовательно предполагает, что каждый драйвер устройства (или иной другой системный файл, выгружаемый в адресное пространство ядра) должен иметь собственную цифровую подпись. В противном случае, система просто откажется грузить этот компонент. Стоит на всякий случай сказать, что изменение системных файлов убивает подпись, поэтому, мои маленькие любители подрочить в ядре, это не прокатит и система скажет, что такой файл не загрузит! Так что да, эта технология существует по большому счету для защиты от вредоносов, работающих на уровне ядра. И, в принципе, он справляется вполне себе неплохо!</p><p>DSE включен по стандарту, но пользователям (только из под админа, конечно же) предоставляется возможность выключить на время проверку подписей (или включить Test Signing Mode, позволяющий загружать самоподписанные драйвера), например, через bcdedit. Правда, это чаще всего нужно только для разработчиков драйверов, когда они тестируют свои наработки.</p><p>С понятием DSE мы вроде разобрались, перейдем к теперь к его инициализации.</p><h2 id="инициализация-driver-signature-enforcement-и-code-integrity"> Инициализация Driver Signature Enforcement и Code Integrity <a href="#инициализация-driver-signature-enforcement-и-code-integrity">#</a></h2><p>DSE является компонентом ядра, а значит, надо искать примерно на этом уровне или чуточку ниже.</p><p>DSE берет свое начало с фазы “ранней загрузки” системы - когда свое дело закончили загрузчики (в данном случае - winload.exe/winload.efi). Это дело выгружается с основными драйверами системы. Нужный нам покемон находится в CI.dll (CodeIntegrity). Если обратить внимание на то, что экспортирует данная DLL мы однозначно можем сказать, что нам нужна функция под именем <code class="language-plaintext highlighter-rouge">CiInitialize</code>: <img src="https://telegra.ph/file/7fb3cd9c955cf7729785a.png" alt="" /></p><p>Однако, давайте не спешить, мы зайдем немного с другого угла и чуточку уйдем от CI.dll.</p><p>Все же не менее важным для ОС, как ни странно, является ядро, а это значит, что упоминание CiInitialize должно быть и там. В действительности, так и есть, более того, эта функция также вызывается во время инициализации системы. <em>Барабанная дробь</em>…</p><p>Давайте посмотрим на функцию из ntoskrnl.exe - <code class="language-plaintext highlighter-rouge">SepInitializeCodeIntegrity</code>. <img src="https://telegra.ph/file/6903d2a8ee5d3114b8c9e.png" alt="" /></p><p>А теперь приведем её в более приличный (и правильный) вид. Заодно я оставлю её как “код”, надеюсь, так будет удобнее:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NTSTATUS SepInitializeCodeIntegrity() {
   unsigned int CiOptions;
   _LIST_ENTRY *p_BootDriverListHead;
   _LOADER_PARAMETER_EXTENSION *Ext;
   _LOADER_PARAMETER_CI_EXTENSION *CodeIntegrityData;
   char *LoadOptions;

   CiOptions = 6;
   memset(&amp;CodeIntegrityCallbacks, 0, 0xC4); // nt!SeCiCallbacks

   p_BootDriverListHead = 0;
   SeCiCallbacks = 0xD0;
   qword_140C1DAA8 = 0xA000008; // nt!SeCiCallbacks + 0xC8

   if(KeLoaderBlock ) {
      Ext = KeLoaderBlock-&gt;Extension;
       if(Ext) {
           CodeIntegrityData = Ext-&gt;CodeIntegrityData;
           if(CodeIntegrityData)
               CiOptions = CodeIntegrityData-&gt;CodeIntegrityOptions;
       }

       // (KeLoaderBlock + 0xD8)
       LoadOptions = KeLoaderBlock-&gt;LoadOptions;
       if(SepIsOptionPresent(LoadOptions) &amp;&amp; LoadOptions)
           SeCiDebugOptions |= 1;
       if(KeLoaderBlock)
           p_BootDriverListHead = &amp;KeLoaderBlock-&gt;BootDriverListHead;
   }

   return CiInitialize(CiOptions, p_BootDriverListHead, &amp;SeCiCallbacks, SeCiPrivateApis);
}
</code></pre></div></div><p>Именно в этой функции мы получаем информацию о существовании <code class="language-plaintext highlighter-rouge">CiInitialize</code> впервые, правда, уже через само ядро. Думаю, стоит разобрать поближе несколько моментов.</p><p>И начну я пожалуй с <code class="language-plaintext highlighter-rouge">SeCiPrivateApis</code>, так как они требуют меньше объяснений и о них можно сказать прямо сейчас. Из названия логично предположить, что <code class="language-plaintext highlighter-rouge">SeCiPrivateApis</code> содержит в себе список некоторых функций, с которыми работает модуль Code Integrity. Данный список содержит в себе оффсеты на функции: <code class="language-plaintext highlighter-rouge">PsQueryProcessSignatureMitigationPolicy</code>, <code class="language-plaintext highlighter-rouge">VslHvciInterface</code> (это оффсет на <code class="language-plaintext highlighter-rouge">VslCreateSecureAllocation</code>), <code class="language-plaintext highlighter-rouge">SepZwLockRegistryKey</code>, <code class="language-plaintext highlighter-rouge">PsQuerySectionSignatureInformation</code>, <code class="language-plaintext highlighter-rouge">SepSetRuntimeUpdatableSigningLevel</code>, <code class="language-plaintext highlighter-rouge">RtlValidProcessProtection</code>, <code class="language-plaintext highlighter-rouge">MmGetImageFileSignatureInformation</code> и <code class="language-plaintext highlighter-rouge">SepGetSystemSigningLevel</code>. Данные функции не будут разбираться в этой статье, однако, я покажу несколько из них. <img src="https://telegra.ph/file/3c57bbca915d7293f7d72.png" alt="" /> <img src="https://telegra.ph/file/b45274c032ea9926fd1b6.png" alt="" /></p><p>Назначение <code class="language-plaintext highlighter-rouge">SeCiCallbacks</code> я разберу в следующем параграфе. Также, не выкидывайте из головы структуру <code class="language-plaintext highlighter-rouge">_LOADER_PARAMETER_CI_EXTENSIONS</code>, с ней есть одна забавная особенность.</p><p>Кстати, забыл показать call stack. Да, функция и в правду вызывается во время инициализации: <img src="https://telegra.ph/file/e4abbe662744d8cde2132.png" alt="" /></p><h2 id="от-ядра-к-модулю"> От ядра к модулю <a href="#от-ядра-к-модулю">#</a></h2><p>Хорошо, мы поняли, что за инициализацию DSE в ядре отвечает функция <code class="language-plaintext highlighter-rouge">SepInitializeCodeIntegrity</code>, данная функция срабатывает во время инициализации самой системы и она вызывает нужный нам <code class="language-plaintext highlighter-rouge">CiInitialize</code>. Самое время глянуть на <code class="language-plaintext highlighter-rouge">CiInitialize</code>! Ииииииии… <img src="https://telegra.ph/file/9c1b4d27a34a71d1aee9b.png" alt="" /></p><p>Да, это очередной враппер над еще одной функцией - <code class="language-plaintext highlighter-rouge">CipInitialize</code>. Интересно, что тут мы имеем упоминание Microsoft WIL (Windows Implementation Library). Это нас не должно особо волновать, данные вещи нам не нужны и не мешают, но, решил просто это отметить.</p><p>Хорошо, <code class="language-plaintext highlighter-rouge">CiInitialize</code> - это враппер. Значит, идем прямиком в <code class="language-plaintext highlighter-rouge">CipInitialize</code>! И, да, это она, именно она отвечает за инициализацию нашего DSE. Это весьма большая функция, поэтому придется разместить её на нескольких скринах. Надеюсь, вы не против. <img src="https://telegra.ph/file/a2e2be4196b714a7a4dc8.png" alt="" /> <img src="https://telegra.ph/file/fa5d863955762c1677c12.png" alt="" /> <img src="https://telegra.ph/file/39ee3395136919466487d.png" alt="" /></p><p>Отлично, мы нашли, где инициализируется DSE! Давайте разберем наиболее примечательные детали. <img src="https://telegra.ph/file/f8d2a79350cd44cb79e01.png" alt="" /></p><p>Данный отрывок проверяет, существует ли оффсет на <code class="language-plaintext highlighter-rouge">VslHvciInterface</code>. Если да - заполняет таблицу <code class="language-plaintext highlighter-rouge">g_CiVslHvciInterface</code>. Я так и не смог понять, точно ли это то, что должно быть в данной таблице (да-да, называйте меня дауном-долбоебом-уебком-etc), поэтому, не упомяну ничего здесь во избежание ошибок. Но, предполагаю, что загружает оно какую-то часть функций отсюда: <img src="https://telegra.ph/file/0fe78ac2a60ef3ccfb6f2.png" alt="" /></p><p>Скорее всего оно загружает все, начиная с <code class="language-plaintext highlighter-rouge">VslCreateSecureAllocation</code> (присутствует в <code class="language-plaintext highlighter-rouge">CiPrivateApis</code>) + <code class="language-plaintext highlighter-rouge">0x10</code>.</p><p>Здесь при вызове HashpSelfTest CI.dll тестирует собственную подпись, что очевидно. В условии тестируются собственные “Root Table”. <img src="https://telegra.ph/file/1aa55a84e5f35e98ded44.png" alt="" /> <img src="https://telegra.ph/file/20d7bb247df59109a70da.png" alt="" /></p><p>А вот здесь у нас есть немножечко примеси Xbox (<code class="language-plaintext highlighter-rouge">XciInitialize</code> импортируется из <code class="language-plaintext highlighter-rouge">ext-ms-win-ci-xbox-l1-1-0</code>), живите с этим. <img src="https://telegra.ph/file/d193ed2b36bc07faed7c1.png" alt="" /></p><p>А вот и самое главное - таблица коллбеков! Именно функции этой таблицы и отвечают за проверку подписей, а значит, мы технически нашли, то, что нам нужно! <img src="https://telegra.ph/file/820e3130699acad4b27c4.png" alt="" /></p><p>Самое главное, что делает <code class="language-plaintext highlighter-rouge">CipInitialize</code> - заполняет таблицу <code class="language-plaintext highlighter-rouge">CiCallbacks</code>, а <code class="language-plaintext highlighter-rouge">CiInitialize</code> передает заполненную таблицу ядру. Теперь, мы поняли, как иницализируется механизм проверки подписей. Осталось понять, каким образом проверяются загружаемые системные модули.</p><h2 id="мы-любим-только-проверенные-образы"> Мы любим только проверенные образы <a href="#мы-любим-только-проверенные-образы">#</a></h2><p>Когда необходимая таблица с указателями на функции заполнилась - система может начинать совершать проверку загружаемых образов в пространство ядра.</p><p>Опытным путем было найдено несколько функций, отвечающих за это. Например, <code class="language-plaintext highlighter-rouge">SeValidateImageHeader</code>: <img src="https://telegra.ph/file/9799da23dd5d410bd4d46.png" alt="" /></p><p>Здесь проводится проверка, существует ли <code class="language-plaintext highlighter-rouge">SeCiCallbacks</code> (или <code class="language-plaintext highlighter-rouge">CiCallbacks</code>, как я обозначал ранее) со смещением <code class="language-plaintext highlighter-rouge">0x20</code> (<code class="language-plaintext highlighter-rouge">CiValidateImageHeader</code>), если да - производим проверку, в противном случае возвращаем NTSTATUS равный <code class="language-plaintext highlighter-rouge">0xC0000428</code> (<code class="language-plaintext highlighter-rouge">STATUS_INVALID_IMAGE_HASH</code>). Call stack для <code class="language-plaintext highlighter-rouge">SeValidateImageHeader</code> выглядит так: <img src="https://telegra.ph/file/15d4b12d4eebb007309b3.png" alt="" /></p><p>Т.е, путь до проверки заголовка образа проходит от загрузки (<code class="language-plaintext highlighter-rouge">MmLoadSystemImage</code>) до самой валидации (<code class="language-plaintext highlighter-rouge">SeValidateImageHeader</code> и <code class="language-plaintext highlighter-rouge">CiValidateImageHeader</code>).</p><p>Это справедливо и для других функций, например для <code class="language-plaintext highlighter-rouge">SeValidateImageData</code> и <code class="language-plaintext highlighter-rouge">CiValidateImageData</code>!</p><h2 id="windbg-и-dse"> WinDBG и DSE <a href="#windbg-и-dse">#</a></h2><p>Забавно, но стоит отметить, что WinDBG, если мы занимаемся отладкой ядра/бутменеджера/бутлоадера, сам отключает DSE, судя по всему это связано со структурой <code class="language-plaintext highlighter-rouge">_LOADER_PARAMETER_CI_EXTENSIONS</code>: <img src="https://telegra.ph/file/16d6ffa7b4779e041b155.png" alt="" /></p><h2 id="структура-_loader_parameter_ci_extensions"> Структура _LOADER_PARAMETER_CI_EXTENSIONS <a href="#структура-_loader_parameter_ci_extensions">#</a></h2><p>К сожалению, у меня она почему-то решила не загружаться (110% я криворукий долбоеб), поэтому вам придется поверить мне на слово, но обычно параметр CodeIntegrityOptions равен 6, однако, при подключенном WinDBG это поле скорее всего становится 0. Скорее всего это связано с тем, что настройки при отладке ядра изменяют это поле, а заодно вместе с ними и WinDBG. Если мы вспомним с чего мы начинали, то можем увидеть это же значение:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CiOptions = 6;
</code></pre></div></div><p>И, да, скорее всего это один из способов обхода механизма DSE.</p><h2 id="выводы"> Выводы <a href="#выводы">#</a></h2><p>В данной статье я немного разобрал механизм инициализации Driver Signature Enforcement, а также немного рассказал, как он работает. Конечно, здесь непаханное поле экспериментов и можно еще что-то глянуть даже.</p><p>Как-то так, не скучайте, не болейте, кушайте хорошо. Водички побольше пейте, воооооот.</p></section><section><nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/2021/12/02/kaspersky-kse"><div class="nav-arrow">Previous</div><span class="post-title">Как мы на Kaspersky в KSE охотились</span> </a></nav></section><div id="disqus_thread" class="article-comments"></div><script> (function() { var d = document, s = d.createElement('script'); s.src = '//____SKVLLZ..disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></main><script> function setTheme(theme) { if (theme === "dark") { document.documentElement.setAttribute('data-theme', 'dark'); window.localStorage.setItem('theme', 'dark'); document.getElementById("theme-toggle").classList.add('sun'); document.getElementById("theme-toggle").classList.remove('moon'); } else { document.documentElement.setAttribute('data-theme', 'light'); window.localStorage.setItem('theme', 'light'); document.getElementById("theme-toggle").classList.add('moon'); document.getElementById("theme-toggle").classList.remove('sun'); } } let theme = localStorage.getItem('theme'); theme = theme || (window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light' : 'light'); setTheme(theme); function modeSwitcher() { let currentMode = document.documentElement.getAttribute('data-theme'); if (currentMode === "dark") { setTheme('light'); } else { setTheme('dark'); } } </script></body><footer class="social-footer"><div class="social-footer-icons"> <a href="https://github.com/0x00Alchemist" title="Github profile" target="_blank" rel="noopener noreferrer"><i class="fa fa-brands fa-github" aria-hidden="true"></i></a> <a href="http://localhost:4000/atom.xml" title="Feed RSS" target="_blank" rel="noopener noreferrer"><i class="fa fa-solid fa-rss" aria-hidden="true"></i></a> <a href="https://github.com/DavideBri/Gesko" title="Browse the code" target="_blank" rel="noopener noreferrer"><i class="fa fa-solid fa-code" aria-hidden="true"></i></a></div></footer></html>
